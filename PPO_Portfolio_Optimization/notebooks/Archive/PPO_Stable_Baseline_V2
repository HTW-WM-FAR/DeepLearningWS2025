{"metadata":{"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python","version":"3.11.13","mimetype":"text/x-python","codemirror_mode":{"name":"ipython","version":3},"pygments_lexer":"ipython3","nbconvert_exporter":"python","file_extension":".py"},"kaggle":{"accelerator":"nvidiaTeslaT4","dataSources":[{"sourceId":13644596,"sourceType":"datasetVersion","datasetId":8673648}],"dockerImageVersionId":31153,"isInternetEnabled":true,"language":"python","sourceType":"notebook","isGpuEnabled":true},"colab":{"provenance":[{"file_id":"https://storage.googleapis.com/kaggle-colab-exported-notebooks/christophbieritz/ppo-stable-baseline-v2.e0d09903-048c-4ed6-b4b2-0352c7265933.ipynb?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=gcp-kaggle-com%40kaggle-161607.iam.gserviceaccount.com/20251108/auto/storage/goog4_request&X-Goog-Date=20251108T060700Z&X-Goog-Expires=259200&X-Goog-SignedHeaders=host&X-Goog-Signature=651bd69ccf890d4aef35ff5f0ed5871631ce648bcadfcd5bfeb3367cf72adf30fffbf3451176c7bc7c23603a2477953ab955d70842f359b891dc50c6f2d9174d578b4c53c0af0c2506d49e830fa3ec5141a2bcd6ed6c72faf1768ad5f10745b2556b303c5f15f80334e18555812e70a5f44cdc3cfb4a284d8380daf3ef38a1884a819b1fe031b4b2209aeccc1d0ee02265eb332a1241d9a9b5564560fd12ed3159f0e7b1181a903c8bebc16062b41e85b67e61b926e73d8e426700c723d319965d53778182a6f215f6a259dde0ddc642cd43358577b99040cf5dbc0c08f175f4d2d004df045cf21ca8fb4705a4e266ef0dda5c42ddbf613a2fb4a62d46714e29","timestamp":1762582068257}]},"widgets":{"application/vnd.jupyter.widget-state+json":{"70f76b6f5f95443f9df28c650430295c":{"model_module":"@jupyter-widgets/controls","model_name":"VBoxModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"VBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"VBoxView","box_style":"","children":["IPY_MODEL_b6c3ebacc12a45a799b0951d32da11e3","IPY_MODEL_638d88dd700647dcbe430602cc0b683b","IPY_MODEL_469861d95b8d4a13aef7b830df142043","IPY_MODEL_208c8d31d7e84632bce70fd19c123ca2","IPY_MODEL_f0d3a9370b984f578b28b9d52b580917"],"layout":"IPY_MODEL_f03ebd3d20cb4a3d909accdda618e9ac"}},"b6c3ebacc12a45a799b0951d32da11e3":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_b97ad70e150948439d554393864b6d24","placeholder":"​","style":"IPY_MODEL_df68a6a1f95b4846a10aac9e889cd08a","value":"<center> <img\nsrc=https://www.kaggle.com/static/images/site-logo.png\nalt='Kaggle'> <br> Create an API token from <a\nhref=\"https://www.kaggle.com/settings/account\" target=\"_blank\">your Kaggle\nsettings page</a> and paste it below along with your Kaggle username. <br> </center>"}},"638d88dd700647dcbe430602cc0b683b":{"model_module":"@jupyter-widgets/controls","model_name":"TextModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"TextModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"TextView","continuous_update":true,"description":"Username:","description_tooltip":null,"disabled":false,"layout":"IPY_MODEL_7a63b68265814f2d82d137f05d4bb7f5","placeholder":"​","style":"IPY_MODEL_04cf7f49bb5f49d0bc998fafd34547e1","value":""}},"469861d95b8d4a13aef7b830df142043":{"model_module":"@jupyter-widgets/controls","model_name":"PasswordModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"PasswordModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"PasswordView","continuous_update":true,"description":"Token:","description_tooltip":null,"disabled":false,"layout":"IPY_MODEL_89d892cf0208482ba1ece86983a7ce16","placeholder":"​","style":"IPY_MODEL_5efa4748b5dd4d93bc93081b91b05c51","value":""}},"208c8d31d7e84632bce70fd19c123ca2":{"model_module":"@jupyter-widgets/controls","model_name":"ButtonModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"ButtonModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"ButtonView","button_style":"","description":"Login","disabled":false,"icon":"","layout":"IPY_MODEL_813cc9a6564d4e1b858afa01b64283cd","style":"IPY_MODEL_70272099a03c4312a4e8aeb1f6b4d747","tooltip":""}},"f0d3a9370b984f578b28b9d52b580917":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_1fd9a899f4af49bf958438a49faf6241","placeholder":"​","style":"IPY_MODEL_8d48d3aa9ecf4cffabc8e574ad66d52f","value":"\n<b>Thank You</b></center>"}},"f03ebd3d20cb4a3d909accdda618e9ac":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":"center","align_self":null,"border":null,"bottom":null,"display":"flex","flex":null,"flex_flow":"column","grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":"50%"}},"b97ad70e150948439d554393864b6d24":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"df68a6a1f95b4846a10aac9e889cd08a":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}},"7a63b68265814f2d82d137f05d4bb7f5":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"04cf7f49bb5f49d0bc998fafd34547e1":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}},"89d892cf0208482ba1ece86983a7ce16":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"5efa4748b5dd4d93bc93081b91b05c51":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}},"813cc9a6564d4e1b858afa01b64283cd":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"70272099a03c4312a4e8aeb1f6b4d747":{"model_module":"@jupyter-widgets/controls","model_name":"ButtonStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"ButtonStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","button_color":null,"font_weight":""}},"1fd9a899f4af49bf958438a49faf6241":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"8d48d3aa9ecf4cffabc8e574ad66d52f":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}}}}},"nbformat_minor":0,"nbformat":4,"cells":[{"cell_type":"code","source":["# 1. Installationen\n","# ----------------------------------------------------------------------\n","# Wir installieren alles in einem Block, damit pip die Versionen\n","# korrekt auflösen kann (numpy 1.26.4 wird erzwungen).\n","\n","!pip install numpy==1.26.4 pandas\n","!pip install stable-baselines3 gymnasium wandb\n","!pip install kagglehub\n","\n","print(\"--- Alle Installationen abgeschlossen. ---\")\n","print(\"!!! WICHTIG: BITTE JETZT 'LAUFZEIT' -> 'LAUFZEIT NEU STARTEN' AUSFÜHREN !!!\")"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"4ChdipO5KQ50","executionInfo":{"status":"ok","timestamp":1762583540969,"user_tz":-60,"elapsed":27544,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}},"outputId":"eeeb6113-3722-402a-9872-5a5d5db2a5ae"},"execution_count":1,"outputs":[{"output_type":"stream","name":"stdout","text":["Requirement already satisfied: numpy==1.26.4 in /usr/local/lib/python3.12/dist-packages (1.26.4)\n","Requirement already satisfied: pandas in /usr/local/lib/python3.12/dist-packages (2.2.2)\n","Requirement already satisfied: python-dateutil>=2.8.2 in /usr/local/lib/python3.12/dist-packages (from pandas) (2.9.0.post0)\n","Requirement already satisfied: pytz>=2020.1 in /usr/local/lib/python3.12/dist-packages (from pandas) (2025.2)\n","Requirement already satisfied: tzdata>=2022.7 in /usr/local/lib/python3.12/dist-packages (from pandas) (2025.2)\n","Requirement already satisfied: six>=1.5 in /usr/local/lib/python3.12/dist-packages (from python-dateutil>=2.8.2->pandas) (1.17.0)\n","Requirement already satisfied: stable-baselines3 in /usr/local/lib/python3.12/dist-packages (2.7.0)\n","Requirement already satisfied: gymnasium in /usr/local/lib/python3.12/dist-packages (1.2.2)\n","Requirement already satisfied: wandb in /usr/local/lib/python3.12/dist-packages (0.22.3)\n","Requirement already satisfied: numpy<3.0,>=1.20 in /usr/local/lib/python3.12/dist-packages (from stable-baselines3) (1.26.4)\n","Requirement already satisfied: torch<3.0,>=2.3 in /usr/local/lib/python3.12/dist-packages (from stable-baselines3) (2.8.0+cu126)\n","Requirement already satisfied: cloudpickle in /usr/local/lib/python3.12/dist-packages (from stable-baselines3) (3.1.2)\n","Requirement already satisfied: pandas in /usr/local/lib/python3.12/dist-packages (from stable-baselines3) (2.2.2)\n","Requirement already satisfied: matplotlib in /usr/local/lib/python3.12/dist-packages (from stable-baselines3) (3.10.0)\n","Requirement already satisfied: typing-extensions>=4.3.0 in /usr/local/lib/python3.12/dist-packages (from gymnasium) (4.15.0)\n","Requirement already satisfied: farama-notifications>=0.0.1 in /usr/local/lib/python3.12/dist-packages (from gymnasium) (0.0.4)\n","Requirement already satisfied: click>=8.0.1 in /usr/local/lib/python3.12/dist-packages (from wandb) (8.3.0)\n","Requirement already satisfied: gitpython!=3.1.29,>=1.0.0 in /usr/local/lib/python3.12/dist-packages (from wandb) (3.1.45)\n","Requirement already satisfied: packaging in /usr/local/lib/python3.12/dist-packages (from wandb) (25.0)\n","Requirement already satisfied: platformdirs in /usr/local/lib/python3.12/dist-packages (from wandb) (4.5.0)\n","Requirement already satisfied: protobuf!=4.21.0,!=5.28.0,<7,>=3.19.0 in /usr/local/lib/python3.12/dist-packages (from wandb) (5.29.5)\n","Requirement already satisfied: pydantic<3 in /usr/local/lib/python3.12/dist-packages (from wandb) (2.11.10)\n","Requirement already satisfied: pyyaml in /usr/local/lib/python3.12/dist-packages (from wandb) (6.0.3)\n","Requirement already satisfied: requests<3,>=2.0.0 in /usr/local/lib/python3.12/dist-packages (from wandb) (2.32.4)\n","Requirement already satisfied: sentry-sdk>=2.0.0 in /usr/local/lib/python3.12/dist-packages (from wandb) (2.43.0)\n","Requirement already satisfied: gitdb<5,>=4.0.1 in /usr/local/lib/python3.12/dist-packages (from gitpython!=3.1.29,>=1.0.0->wandb) (4.0.12)\n","Requirement already satisfied: annotated-types>=0.6.0 in /usr/local/lib/python3.12/dist-packages (from pydantic<3->wandb) (0.7.0)\n","Requirement already satisfied: pydantic-core==2.33.2 in /usr/local/lib/python3.12/dist-packages (from pydantic<3->wandb) (2.33.2)\n","Requirement already satisfied: typing-inspection>=0.4.0 in /usr/local/lib/python3.12/dist-packages (from pydantic<3->wandb) (0.4.2)\n","Requirement already satisfied: charset_normalizer<4,>=2 in /usr/local/lib/python3.12/dist-packages (from requests<3,>=2.0.0->wandb) (3.4.4)\n","Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.12/dist-packages (from requests<3,>=2.0.0->wandb) (3.11)\n","Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.12/dist-packages (from requests<3,>=2.0.0->wandb) (2.5.0)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.12/dist-packages (from requests<3,>=2.0.0->wandb) (2025.10.5)\n","Requirement already satisfied: filelock in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (3.20.0)\n","Requirement already satisfied: setuptools in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (75.2.0)\n","Requirement already satisfied: sympy>=1.13.3 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (1.13.3)\n","Requirement already satisfied: networkx in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (3.5)\n","Requirement already satisfied: jinja2 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (3.1.6)\n","Requirement already satisfied: fsspec in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (2025.3.0)\n","Requirement already satisfied: nvidia-cuda-nvrtc-cu12==12.6.77 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (12.6.77)\n","Requirement already satisfied: nvidia-cuda-runtime-cu12==12.6.77 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (12.6.77)\n","Requirement already satisfied: nvidia-cuda-cupti-cu12==12.6.80 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (12.6.80)\n","Requirement already satisfied: nvidia-cudnn-cu12==9.10.2.21 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (9.10.2.21)\n","Requirement already satisfied: nvidia-cublas-cu12==12.6.4.1 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (12.6.4.1)\n","Requirement already satisfied: nvidia-cufft-cu12==11.3.0.4 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (11.3.0.4)\n","Requirement already satisfied: nvidia-curand-cu12==10.3.7.77 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (10.3.7.77)\n","Requirement already satisfied: nvidia-cusolver-cu12==11.7.1.2 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (11.7.1.2)\n","Requirement already satisfied: nvidia-cusparse-cu12==12.5.4.2 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (12.5.4.2)\n","Requirement already satisfied: nvidia-cusparselt-cu12==0.7.1 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (0.7.1)\n","Requirement already satisfied: nvidia-nccl-cu12==2.27.3 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (2.27.3)\n","Requirement already satisfied: nvidia-nvtx-cu12==12.6.77 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (12.6.77)\n","Requirement already satisfied: nvidia-nvjitlink-cu12==12.6.85 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (12.6.85)\n","Requirement already satisfied: nvidia-cufile-cu12==1.11.1.6 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (1.11.1.6)\n","Requirement already satisfied: triton==3.4.0 in /usr/local/lib/python3.12/dist-packages (from torch<3.0,>=2.3->stable-baselines3) (3.4.0)\n","Requirement already satisfied: contourpy>=1.0.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (1.3.3)\n","Requirement already satisfied: cycler>=0.10 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (0.12.1)\n","Requirement already satisfied: fonttools>=4.22.0 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (4.60.1)\n","Requirement already satisfied: kiwisolver>=1.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (1.4.9)\n","Requirement already satisfied: pillow>=8 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (11.3.0)\n","Requirement already satisfied: pyparsing>=2.3.1 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (3.2.5)\n","Requirement already satisfied: python-dateutil>=2.7 in /usr/local/lib/python3.12/dist-packages (from matplotlib->stable-baselines3) (2.9.0.post0)\n","Requirement already satisfied: pytz>=2020.1 in /usr/local/lib/python3.12/dist-packages (from pandas->stable-baselines3) (2025.2)\n","Requirement already satisfied: tzdata>=2022.7 in /usr/local/lib/python3.12/dist-packages (from pandas->stable-baselines3) (2025.2)\n","Requirement already satisfied: smmap<6,>=3.0.1 in /usr/local/lib/python3.12/dist-packages (from gitdb<5,>=4.0.1->gitpython!=3.1.29,>=1.0.0->wandb) (5.0.2)\n","Requirement already satisfied: six>=1.5 in /usr/local/lib/python3.12/dist-packages (from python-dateutil>=2.7->matplotlib->stable-baselines3) (1.17.0)\n","Requirement already satisfied: mpmath<1.4,>=1.1.0 in /usr/local/lib/python3.12/dist-packages (from sympy>=1.13.3->torch<3.0,>=2.3->stable-baselines3) (1.3.0)\n","Requirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.12/dist-packages (from jinja2->torch<3.0,>=2.3->stable-baselines3) (3.0.3)\n","Requirement already satisfied: kagglehub in /usr/local/lib/python3.12/dist-packages (0.3.13)\n","Requirement already satisfied: packaging in /usr/local/lib/python3.12/dist-packages (from kagglehub) (25.0)\n","Requirement already satisfied: pyyaml in /usr/local/lib/python3.12/dist-packages (from kagglehub) (6.0.3)\n","Requirement already satisfied: requests in /usr/local/lib/python3.12/dist-packages (from kagglehub) (2.32.4)\n","Requirement already satisfied: tqdm in /usr/local/lib/python3.12/dist-packages (from kagglehub) (4.67.1)\n","Requirement already satisfied: charset_normalizer<4,>=2 in /usr/local/lib/python3.12/dist-packages (from requests->kagglehub) (3.4.4)\n","Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.12/dist-packages (from requests->kagglehub) (3.11)\n","Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.12/dist-packages (from requests->kagglehub) (2.5.0)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.12/dist-packages (from requests->kagglehub) (2025.10.5)\n","--- Alle Installationen abgeschlossen. ---\n","!!! WICHTIG: BITTE JETZT 'LAUFZEIT' -> 'LAUFZEIT NEU STARTEN' AUSFÜHREN !!!\n"]}]},{"source":["# IMPORTANT: SOME KAGGLE DATA SOURCES ARE PRIVATE\n","# RUN THIS CELL IN ORDER TO IMPORT YOUR KAGGLE DATA SOURCES.\n","import kagglehub\n","kagglehub.login()\n","\n","{\"username\":\"christophbieritz\",\"key\":\"3686987acedb440889f6af188d0e17c8\"}\n"],"metadata":{"id":"4WXNFozdE1E_","colab":{"base_uri":"https://localhost:8080/","height":291,"referenced_widgets":["70f76b6f5f95443f9df28c650430295c","b6c3ebacc12a45a799b0951d32da11e3","638d88dd700647dcbe430602cc0b683b","469861d95b8d4a13aef7b830df142043","208c8d31d7e84632bce70fd19c123ca2","f0d3a9370b984f578b28b9d52b580917","f03ebd3d20cb4a3d909accdda618e9ac","b97ad70e150948439d554393864b6d24","df68a6a1f95b4846a10aac9e889cd08a","7a63b68265814f2d82d137f05d4bb7f5","04cf7f49bb5f49d0bc998fafd34547e1","89d892cf0208482ba1ece86983a7ce16","5efa4748b5dd4d93bc93081b91b05c51","813cc9a6564d4e1b858afa01b64283cd","70272099a03c4312a4e8aeb1f6b4d747","1fd9a899f4af49bf958438a49faf6241","8d48d3aa9ecf4cffabc8e574ad66d52f"]},"executionInfo":{"status":"ok","timestamp":1762583577930,"user_tz":-60,"elapsed":69,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}},"outputId":"271524e0-0aa1-4a10-d55a-293340335653"},"cell_type":"code","outputs":[{"output_type":"display_data","data":{"text/plain":["VBox(children=(HTML(value='<center> <img\\nsrc=https://www.kaggle.com/static/images/site-logo.png\\nalt=\\'Kaggle…"],"application/vnd.jupyter.widget-view+json":{"version_major":2,"version_minor":0,"model_id":"70f76b6f5f95443f9df28c650430295c"}},"metadata":{}},{"output_type":"execute_result","data":{"text/plain":["{'username': 'christophbieritz', 'key': '3686987acedb440889f6af188d0e17c8'}"]},"metadata":{},"execution_count":4}],"execution_count":4},{"source":["# IMPORTANT: RUN THIS CELL IN ORDER TO IMPORT YOUR KAGGLE DATA SOURCES,\n","# THEN FEEL FREE TO DELETE THIS CELL.\n","# NOTE: THIS NOTEBOOK ENVIRONMENT DIFFERS FROM KAGGLE'S PYTHON\n","# ENVIRONMENT SO THERE MAY BE MISSING LIBRARIES USED BY YOUR\n","# NOTEBOOK.\n","\n","christophbieritz_toy_data_path = kagglehub.dataset_download('christophbieritz/toy-data')\n","\n","print('Data source import complete.')\n"],"metadata":{"id":"y6aG3WBfE1FA","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1762583583874,"user_tz":-60,"elapsed":225,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}},"outputId":"4c25385c-225e-48d1-cab4-a18cd6a698e5"},"cell_type":"code","outputs":[{"output_type":"stream","name":"stdout","text":["Data source import complete.\n"]}],"execution_count":5},{"cell_type":"raw","source":[],"metadata":{"id":"Uq7D4Xx1E1FB"}},{"cell_type":"code","source":["# 2. Standard-Bibliotheken\n","# ----------------------------------------------------------------------\n","import os\n","from typing import List, Dict, Optional, Callable\n","from functools import partial\n","\n","# 3. Daten & ML-Bibliotheken (Pandas, Numpy, PyTorch, Gym)\n","# ----------------------------------------------------------------------\n","import numpy as np\n","import pandas as pd\n","import torch\n","import torch.nn as nn\n","from torch.distributions import Dirichlet\n","import gymnasium as gym\n","from gymnasium import spaces\n","\n","# 4. Stable Baselines 3 (SB3)\n","# ----------------------------------------------------------------------\n","from stable_baselines3 import PPO\n","from stable_baselines3.common.policies import ActorCriticPolicy\n","from stable_baselines3.common.torch_layers import BaseFeaturesExtractor\n","from stable_baselines3.common.monitor import Monitor\n","from stable_baselines3.common.vec_env import DummyVecEnv, SubprocVecEnv\n","from stable_baselines3.common.distributions import Distribution\n","from stable_baselines3.common.callbacks import BaseCallback, EvalCallback, CallbackList\n","\n","# 5. Weights & Biases (W&B)\n","# ----------------------------------------------------------------------\n","import wandb\n","from wandb.integration.sb3 import WandbCallback\n","\n","print(\"--- Alle Imports abgeschlossen ---\")"],"metadata":{"_uuid":"8f2839f25d086af736a60e9eeb907d3b93b6e0e5","_cell_guid":"b1076dfc-b9ad-4769-8c92-a6c4dae69d19","trusted":true,"execution":{"iopub.status.busy":"2025-11-08T06:04:21.18345Z","iopub.execute_input":"2025-11-08T06:04:21.183657Z","iopub.status.idle":"2025-11-08T06:04:43.41714Z","shell.execute_reply.started":"2025-11-08T06:04:21.183637Z","shell.execute_reply":"2025-11-08T06:04:43.416329Z"},"id":"usf9fHh4E1FC","outputId":"cd59279e-bc5f-4aca-bf3a-eeb85c7cae69","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1762583640333,"user_tz":-60,"elapsed":53593,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}}},"outputs":[{"output_type":"stream","name":"stderr","text":["Gym has been unmaintained since 2022 and does not support NumPy 2.0 amongst other critical functionality.\n","Please upgrade to Gymnasium, the maintained drop-in replacement of Gym, or contact the authors of your software and request that they upgrade.\n","See the migration guide at https://gymnasium.farama.org/introduction/migration_guide/ for additional information.\n","/usr/local/lib/python3.12/dist-packages/jupyter_client/session.py:203: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n","  return datetime.utcnow().replace(tzinfo=utc)\n","/usr/local/lib/python3.12/dist-packages/jupyter_client/session.py:203: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).\n","  return datetime.utcnow().replace(tzinfo=utc)\n"]}],"execution_count":6},{"cell_type":"code","source":["print(\"--- Alle Imports abgeschlossen ---\")\n","\n","\n","# 6. W&B Login (via Kaggle Secrets)\n","# ----------------------------------------------------------------------\n","user_secrets = UserSecretsClient()\n","wandb_api_key = user_secrets.get_secret(\"WANDB_API_KEY\")\n","os.environ['WANDB_API_KEY'] = wandb_api_key\n","os.environ['WANDB_NOTEBOOK_NAME'] = \"PPO_Stable_Baseline_V2.ipynb\"\n","# ------------------------------------\n","\n","print(\"--- W&B API Key und Notebook-Name gesetzt ---\")"],"metadata":{"trusted":true,"execution":{"iopub.status.busy":"2025-11-08T06:04:43.417887Z","iopub.execute_input":"2025-11-08T06:04:43.418168Z","iopub.status.idle":"2025-11-08T06:04:43.507862Z","shell.execute_reply.started":"2025-11-08T06:04:43.418143Z","shell.execute_reply":"2025-11-08T06:04:43.507296Z"},"id":"laRv2AkXE1FD","outputId":"d8ee3a8c-f6ac-4fdc-ad73-b17ce0ffb881","colab":{"base_uri":"https://localhost:8080/","height":239},"executionInfo":{"status":"error","timestamp":1762583659317,"user_tz":-60,"elapsed":60,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}}},"outputs":[{"output_type":"stream","name":"stdout","text":["--- Alle Imports abgeschlossen ---\n"]},{"output_type":"error","ename":"NameError","evalue":"name 'UserSecretsClient' is not defined","traceback":["\u001b[0;31m---------------------------------------------------------------------------\u001b[0m","\u001b[0;31mNameError\u001b[0m                                 Traceback (most recent call last)","\u001b[0;32m/tmp/ipython-input-3059464002.py\u001b[0m in \u001b[0;36m<cell line: 0>\u001b[0;34m()\u001b[0m\n\u001b[1;32m      4\u001b[0m \u001b[0;31m# 6. W&B Login (via Kaggle Secrets)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m      5\u001b[0m \u001b[0;31m# ----------------------------------------------------------------------\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m----> 6\u001b[0;31m \u001b[0muser_secrets\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mUserSecretsClient\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m      7\u001b[0m \u001b[0mwandb_api_key\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0muser_secrets\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mget_secret\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m\"WANDB_API_KEY\"\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m      8\u001b[0m \u001b[0mos\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0menviron\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0;34m'WANDB_API_KEY'\u001b[0m\u001b[0;34m]\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mwandb_api_key\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;31mNameError\u001b[0m: name 'UserSecretsClient' is not defined"]}],"execution_count":7},{"cell_type":"code","source":["import torch\n","\n","if torch.cuda.is_available():\n","    print(\"GPU-Test erfolgreich: True\")\n","    print(f\"Gerätename: {torch.cuda.get_device_name(0)}\")\n","else:\n","    print(\"GPU-Test FEHLGESCHLAGEN: False\")"],"metadata":{"trusted":true,"execution":{"iopub.status.busy":"2025-11-08T06:04:43.508572Z","iopub.execute_input":"2025-11-08T06:04:43.508794Z","iopub.status.idle":"2025-11-08T06:04:46.153472Z","shell.execute_reply.started":"2025-11-08T06:04:43.508776Z","shell.execute_reply":"2025-11-08T06:04:46.152833Z"},"id":"LySyxeXTE1FD","executionInfo":{"status":"aborted","timestamp":1762583542563,"user_tz":-60,"elapsed":29246,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}}},"outputs":[],"execution_count":null},{"cell_type":"code","source":["# ----------------------------------------------------------------------\n","# 2. Hyperparameter\n","# ----------------------------------------------------------------------\n","\n","# --- 1. Environment Hyperparameter ---\n","initial_balance = 10000.0\n","window_size = 30\n","transaction_cost_pct = 0.000\n","\n","# --- 2. Training Run & Parallelisierung ---\n","# Gesamt-Timesteps für SB3 (ersetzt num_iterations)\n","total_timesteps_per_run = 2500000\n","# Anzahl der CPU-Kerne für SubprocVecEnv\n","NUM_CPU_CORES = 8\n","\n","# --- 3. PPO Algorithm Hyperparameter ---\n","# (Angepasst für CPU/GPU-Balance & Stabilität)\n","steps_per_rollout = 4096   # SB3: n_steps (Daten pro CPU-Kern pro Sammlung)\n","num_ppo_epochs = 4      # SB3: n_epochs (Standardwert, stabil)\n","mini_batch_size = 1024    # SB3: batch_size (Größere Batches sind effizienter)\n","\n","# (Standard-PPO-Werte)\n","learning_rate = 0.0003\n","gamma = 0.99\n","lambda_gae = 0.95\n","ppo_clip_epsilon = 0.2     # SB3: clip_range\n","vf_loss_coeff = 0.5        # SB3: vf_coef\n","entropy_coeff = 0.001    # SB3: ent_coef (Reduziert für Finanzdaten)\n","\n","\n","print(f\"--- Hyperparameter gesetzt ---\")\n","print(f\"Jeder Run: {total_timesteps_per_run:,} Schritte\")\n","print(f\"Parallelisierung: {NUM_CPU_CORES} Kerne\")\n","print(f\"PPO n_steps: {steps_per_rollout} | n_epochs: {num_ppo_epochs} | batch_size: {mini_batch_size}\")"],"metadata":{"trusted":true,"execution":{"iopub.status.busy":"2025-11-08T06:04:46.15514Z","iopub.execute_input":"2025-11-08T06:04:46.155352Z","iopub.status.idle":"2025-11-08T06:04:46.160851Z","shell.execute_reply.started":"2025-11-08T06:04:46.155335Z","shell.execute_reply":"2025-11-08T06:04:46.160159Z"},"id":"1TbVyxwWE1FD","executionInfo":{"status":"aborted","timestamp":1762583542567,"user_tz":-60,"elapsed":29246,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}}},"outputs":[],"execution_count":null},{"cell_type":"code","source":["# ----------------------------------------------------------------------\n","# 1. Softmax Helferfunktion\n","# ----------------------------------------------------------------------\n","\n","def softmax(x: np.ndarray) -> np.ndarray:\n","    \"\"\"Numerisch stabiles Softmax\"\"\"\n","    if x.ndim == 0:\n","        return np.array(1.0)\n","    e_x = np.exp(x - np.max(x))\n","    return e_x / e_x.sum(axis=0)\n","\n","\n","# ----------------------------------------------------------------------\n","# 2. Angepasste Environment Class (NUR Log-Return)\n","# ----------------------------------------------------------------------\n","\n","class PortfolioEnv(gym.Env):\n","    \"\"\"\n","    Eine Gymnasium-Umgebung für das Portfolio-Management.\n","    Verwendet Softmax-Hack und NUR Log-Return als Belohnung.\n","    \"\"\"\n","\n","    metadata = {\"render_modes\": [\"human\"]}\n","\n","    def __init__(\n","        self,\n","        csv_path: str,\n","        return_cols: List[str],\n","        initial_balance: float = initial_balance,\n","        window_size: int = window_size,\n","        transaction_cost_pct: float = transaction_cost_pct,\n","        # sharpe_window wurde entfernt\n","    ):\n","\n","        super().__init__()\n","\n","        # --- Parameter speichern ---\n","        self.csv_path = csv_path\n","        self.window_size = window_size\n","        self.initial_balance = initial_balance\n","        self.transaction_cost_pct = transaction_cost_pct\n","        # self.sharpe_window wurde entfernt\n","\n","        # --- Asset-Konfiguration ---\n","        self.asset_return_columns = return_cols\n","        self.num_assets = len(self.asset_return_columns)\n","        self.num_portfolio_components = self.num_assets + 1 # (Assets + 1 Cash)\n","\n","        # --- Daten laden ---\n","        self._load_data_csv()\n","\n","        # --- Interne Zustandsvariablen ---\n","        self.start_tick = self.window_size\n","        self.end_tick = len(self.df) - 1\n","\n","        self.current_step = 0\n","        self.portfolio_value = 0.0\n","        self.prev_portfolio_value = 0.0\n","        self.portfolio_weights = np.zeros(\n","            self.num_portfolio_components, dtype=np.float32\n","        )\n","        self.done = False\n","        # _return_history und _sharpe_history entfernt\n","\n","        # --- 1. Action Space (Kontinuierlich) ---\n","        # SB3 benötigt endliche Grenzen [-1, 1].\n","        # Softmax in step() wandelt dies in Gewichte um.\n","        self.action_space = spaces.Box(\n","            low=-1.0, high=1.0, shape=(self.num_portfolio_components,), dtype=np.float32\n","        )\n","\n","        # --- 2. Observation Space (Dictionary) ---\n","        self.observation_space = spaces.Dict(\n","            {\n","                \"market_data\": spaces.Box(\n","                    low=-np.inf,\n","                    high=np.inf,\n","                    shape=(self.window_size, self.num_assets),\n","                    dtype=np.float32,\n","                ),\n","                \"portfolio_weights\": spaces.Box(\n","                    low=0.0,\n","                    high=1.0,\n","                    shape=(self.num_portfolio_components,),\n","                    dtype=np.float32,\n","                ),\n","            }\n","        )\n","\n","    def _load_data_csv(self):\n","        try:\n","            self.df = pd.read_csv(self.csv_path)\n","\n","            if \"Date\" in self.df.columns:\n","                self.df[\"Date\"] = pd.to_datetime(self.df[\"Date\"])\n","                self.df.set_index(\"Date\", inplace=True)\n","\n","            if len(self.df) < self.window_size + 1:\n","                raise ValueError(\n","                    f\"Nicht genügend Daten ({len(self.df)}) für window_size={self.window_size}.\"\n","                )\n","            print(\n","                f\"Daten erfolgreich geladen: {len(self.df)} Zeitschritte, {self.num_assets} Assets.\"\n","            )\n","\n","            # --- GESCHWINDIGKEITS-OPTIMIERUNG ---\n","            # Wandle die DF-Spalten einmal in ein schnelles NumPy-Array um.\n","            self._market_data_numpy = self.df[self.asset_return_columns].values.astype(np.float32)\n","\n","        except FileNotFoundError:\n","            print(f\"Fehler: CSV-Datei {self.csv_path} nicht gefunden.\")\n","            raise\n","\n","    def _get_observation(self) -> Dict[str, np.ndarray]:\n","        end_idx = self.current_step\n","        start_idx = end_idx - self.window_size\n","\n","        # --- GESCHWINDIGKEITS-OPTIMIERUNG ---\n","        # Nutze das schnelle NumPy-Array statt langsames .iloc\n","        market_data = self._market_data_numpy[start_idx:end_idx]\n","\n","        obs_dict = {\n","            \"market_data\": market_data,\n","            \"portfolio_weights\": self.portfolio_weights.astype(np.float32),\n","        }\n","        return obs_dict\n","\n","    def _calculate_reward(self) -> float:\n","        if self.prev_portfolio_value <= 1e-6:\n","            return 0.0\n","        # Log-Return als Belohnung (Standard-Belohnung)\n","        reward = np.log(self.portfolio_value / self.prev_portfolio_value)\n","        if np.isnan(reward) or not np.isfinite(reward):\n","            reward = -10.0 # Starke Strafe für ungültige Zustände\n","        return reward\n","\n","    # --- _calculate_reward_sharpe WURDE ENTFERNT ---\n","\n","    def reset(\n","        self, seed: Optional[int] = None, options: Optional[dict] = None\n","    ) -> (dict, dict):\n","        super().reset(seed=seed)\n","        self.current_step = self.start_tick\n","        self.portfolio_value = self.initial_balance\n","        self.prev_portfolio_value = self.initial_balance\n","        self.portfolio_weights = np.zeros(\n","            self.num_portfolio_components, dtype=np.float32\n","        )\n","        self.portfolio_weights[0] = 1.0 # Start mit 100% Cash\n","        self.done = False\n","        # _return_history und _sharpe_history entfernt\n","\n","        observation = self._get_observation()\n","        info = {}\n","        return observation, info\n","\n","    def step(self, action: np.ndarray) -> (dict, float, bool, bool, dict):\n","        if self.done:\n","            return self._get_observation(), 0.0, True, False, {'info': 'Episode finished.'}\n","\n","        self.prev_portfolio_value = self.portfolio_value\n","        old_actual_weights = self.portfolio_weights\n","\n","        # --- 2. Aktion (Ziel-Gewichte) validieren/normalisieren ---\n","        # Softmax-Hack\n","        target_weights = softmax(action)\n","\n","        # --- 3. Transaktions-Update (Aktiv) ---\n","        turnover = np.sum(np.abs(target_weights[1:] - old_actual_weights[1:]))\n","        costs = turnover * self.prev_portfolio_value * self.transaction_cost_pct\n","\n","        portfolio_value_after_costs = self.prev_portfolio_value - costs\n","\n","        self.portfolio_weights = target_weights\n","\n","        # --- 4. Markt-Update (Passiv) ---\n","        current_returns = self._market_data_numpy[self.current_step] # Optimiert\n","        returns_vector = np.concatenate(([0.0], current_returns)).astype(np.float32)\n","\n","        self.portfolio_value = portfolio_value_after_costs * np.sum(self.portfolio_weights * (1 + returns_vector))\n","\n","        # --- 5. Pleite-Check ---\n","        if self.portfolio_value <= 1e-6:\n","            self.portfolio_value = 0.0\n","            self.done = True\n","\n","        # --- 6. Belohnung berechnen ---\n","        # <--- NUR LOG-RETURN WIRD VERWENDET ---\n","        reward = self._calculate_reward()\n","        # -------------------------------------\n","\n","        # --- 7. Zum nächsten Tag gehen & Ende prüfen ---\n","        self.current_step += 1\n","        if self.current_step > self.end_tick:\n","            self.done = True\n","\n","        # --- 8. Nächste Observation und Info zurückgeben ---\n","        observation = self._get_observation()\n","        info = {\n","            'portfolio_value': self.portfolio_value,\n","            'transaction_costs': costs\n","        }\n","\n","        terminated = self.done\n","        truncated = False\n","\n","        return observation, reward, terminated, truncated, info\n","\n","    def close(self):\n","        pass\n","\n","print(\"--- PortfolioEnv Klasse (NUR Log-Return, optimiert) definiert ---\")"],"metadata":{"trusted":true,"execution":{"iopub.status.busy":"2025-11-08T06:04:46.161665Z","iopub.execute_input":"2025-11-08T06:04:46.162019Z","iopub.status.idle":"2025-11-08T06:04:46.184992Z","shell.execute_reply.started":"2025-11-08T06:04:46.161995Z","shell.execute_reply":"2025-11-08T06:04:46.184391Z"},"id":"GvvxJD8DE1FE","executionInfo":{"status":"aborted","timestamp":1762583542570,"user_tz":-60,"elapsed":29246,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}}},"outputs":[],"execution_count":null},{"cell_type":"code","source":["import torch\n","import torch.nn as nn\n","from gymnasium import spaces\n","from stable_baselines3.common.torch_layers import BaseFeaturesExtractor\n","\n","class CustomCombinedExtractor(BaseFeaturesExtractor):\n","    \"\"\"LSTM-Extraktion der Marktdaten und Konkatenierung mit Portfolio-Gewichten.\"\"\"\n","    def __init__(self, observation_space: spaces.Dict):\n","        self.lstm_features = 64\n","        market_space = observation_space[\"market_data\"]\n","        weights_space = observation_space[\"portfolio_weights\"]\n","        features_dim = self.lstm_features + weights_space.shape[0]\n","\n","        super().__init__(observation_space, features_dim)\n","\n","        self.lstm = nn.LSTM(\n","            input_size=market_space.shape[-1],\n","            hidden_size=self.lstm_features,\n","            batch_first=True\n","        )\n","\n","    def forward(self, observations: dict) -> torch.Tensor:\n","        market_data = observations[\"market_data\"]\n","        portfolio_weights = observations[\"portfolio_weights\"]\n","        lstm_out, (hidden, cell) = self.lstm(market_data)\n","        last_hidden_state = hidden[-1]\n","\n","        combined_features = torch.cat([last_hidden_state, portfolio_weights], dim=1)\n","        return combined_features"],"metadata":{"trusted":true,"execution":{"iopub.status.busy":"2025-11-08T06:04:46.185743Z","iopub.execute_input":"2025-11-08T06:04:46.186072Z","iopub.status.idle":"2025-11-08T06:04:46.204941Z","shell.execute_reply.started":"2025-11-08T06:04:46.186054Z","shell.execute_reply":"2025-11-08T06:04:46.204406Z"},"id":"CX7qW-QLE1FF","executionInfo":{"status":"aborted","timestamp":1762583542573,"user_tz":-60,"elapsed":29246,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}}},"outputs":[],"execution_count":null},{"cell_type":"code","source":["class CustomDirichletDistribution(Distribution):\n","    \"\"\"\n","    Ersetzt die Gaußsche Policy. Erzeugt Alpha-Parameter für die Dirichlet-Verteilung.\n","    Verwendet softplus + 1.0, um Alpha > 1 zu gewährleisten (stabiler).\n","    \"\"\"\n","    def __init__(self, action_dim: int):\n","        super().__init__()\n","        self.action_dim = action_dim\n","\n","    def proba_distribution_net(self, latent_dim: int) -> nn.Module:\n","        \"\"\"Der Actor-Kopf, der die Alpha-Inputs erzeugt.\"\"\"\n","        # Output-Layer, dessen Ausgabe durch softplus + 1.0 geschickt wird\n","        action_net = nn.Linear(latent_dim, self.action_dim)\n","        return action_net\n","\n","    def proba_distribution(self, action_net_output: torch.Tensor) -> \"CustomDirichletDistribution\":\n","        \"\"\"Erzeugt die Dirichlet-Verteilung aus dem Netz-Output.\"\"\"\n","        # Alpha-Parameter MÜSSEN > 0 sein. Wir erzwingen Alpha > 1.0\n","        alphas = torch.nn.functional.softplus(action_net_output) + 1.0\n","        self.distribution = Dirichlet(alphas)\n","        return self\n","\n","    # --- Wichtige Methoden, die PPO benötigt ---\n","\n","    def log_prob(self, actions: torch.Tensor) -> torch.Tensor:\n","        \"\"\"Log-Wahrscheinlichkeit mit Clipping zur Vermeidung von log(0).\"\"\"\n","        # Aktion clippen, da 0.0 in Dirichlet-log_prob nicht erlaubt ist\n","        actions_clipped = torch.clamp(actions, 1e-6, 1.0 - 1e-6)\n","\n","        # Dirichlet benötigt, dass die Aktionen sum(1) ergeben.\n","        # Im PPO-Rollout-Buffer sind die Aktionen (Gewichte) bereits sum(1),\n","        # aber dies stellt die Sicherheit her:\n","        actions_normalized = actions_clipped / torch.sum(actions_clipped, dim=-1, keepdim=True)\n","\n","        return self.distribution.log_prob(actions_normalized)\n","\n","    def entropy(self) -> torch.Tensor:\n","        return self.distribution.entropy()\n","\n","    def sample(self) -> torch.Tensor:\n","        # rsample() wird für die Reparametrisierung benötigt\n","        return self.distribution.rsample()\n","\n","    def mode(self) -> torch.Tensor:\n","        # Für deterministische Aktionen (z.B. im EvalCallback)\n","        return self.distribution.mean # Der Mittelwert der Dirichlet-Verteilung\n","\n","    def actions_from_params(self, action_net_output: torch.Tensor, deterministic: bool = False) -> torch.Tensor:\n","        \"\"\"Wird von PPO zur Erzeugung der finalen Aktionen verwendet.\"\"\"\n","        self.proba_distribution(action_net_output)\n","        if deterministic:\n","            return self.mode()\n","        return self.sample()\n","\n","    def log_prob_from_params(self, action_net_output: torch.Tensor) -> (torch.Tensor, torch.Tensor):\n","        \"\"\"Erzeugt Aktion und log_prob für den Rollout-Buffer.\"\"\"\n","        self.proba_distribution(action_net_output)\n","        actions = self.sample()\n","        log_prob = self.log_prob(actions)\n","        return actions, log_prob"],"metadata":{"trusted":true,"execution":{"iopub.status.busy":"2025-11-08T06:04:46.205715Z","iopub.execute_input":"2025-11-08T06:04:46.206009Z","iopub.status.idle":"2025-11-08T06:04:46.227666Z","shell.execute_reply.started":"2025-11-08T06:04:46.205992Z","shell.execute_reply":"2025-11-08T06:04:46.226993Z"},"id":"_wi4lAi-E1FF","executionInfo":{"status":"aborted","timestamp":1762583542583,"user_tz":-60,"elapsed":7,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}}},"outputs":[],"execution_count":null},{"cell_type":"code","source":["class CustomActorCriticPolicy(ActorCriticPolicy):\n","    \"\"\"\n","    Eine Policy, die SB3 anweist, unsere CustomDirichletDistribution zu verwenden.\n","    \"\"\"\n","    def __init__(self, *args, **kwargs):\n","        super().__init__(*args, **kwargs)\n","\n","    def _get_action_dist_from_space(self, action_space: spaces.Box) -> CustomDirichletDistribution:\n","        \"\"\"\n","        Überschreibt die Standard-Logik (die Gaussian wäre),\n","        um unsere Dirichlet-Verteilung zu verwenden.\n","        \"\"\"\n","        assert isinstance(action_space, spaces.Box), \"DirichletPolicy unterstützt nur Box Action Space.\"\n","\n","        # Die Dimension ist die Anzahl der Portfolio-Komponenten (Assets + Cash)\n","        action_dim = action_space.shape[0]\n","        return CustomDirichletDistribution(action_dim)"],"metadata":{"trusted":true,"execution":{"iopub.status.busy":"2025-11-08T06:04:46.228418Z","iopub.execute_input":"2025-11-08T06:04:46.2287Z","iopub.status.idle":"2025-11-08T06:04:46.247722Z","shell.execute_reply.started":"2025-11-08T06:04:46.228683Z","shell.execute_reply":"2025-11-08T06:04:46.247077Z"},"id":"OyXhMH7lE1FG","executionInfo":{"status":"aborted","timestamp":1762583542586,"user_tz":-60,"elapsed":9,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}}},"outputs":[],"execution_count":null},{"cell_type":"code","source":[],"metadata":{"trusted":true,"id":"AyaMPq8HE1FG","executionInfo":{"status":"aborted","timestamp":1762583542590,"user_tz":-60,"elapsed":11,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}}},"outputs":[],"execution_count":null},{"cell_type":"code","source":["# ----------------------------------------------------------------------\n","# 3. Custom Callback für Step Rewards (Effizient & Korrekt)\n","# ----------------------------------------------------------------------\n","\n","class AvgStepRewardLogger(BaseCallback):\n","    \"\"\"\n","    Sammelt alle Step-Rewards während des Rollouts (von allen Kernen)\n","    und loggt deren DURCHSCHNITT am ENDE des Rollouts in den SB3-Logger.\n","\n","    WandbCallback holt sich diesen Wert automatisch.\n","    Dies ist die effizienteste Methode, um die durchschnittliche\n","    Step-Belohnung zu messen.\n","    \"\"\"\n","    def __init__(self, verbose=0):\n","        super(AvgStepRewardLogger, self).__init__(verbose)\n","        self.step_rewards = [] # Puffer für alle Rewards im Rollout\n","\n","    def _on_step(self) -> bool:\n","        \"\"\"\n","        Wird bei jedem Schritt (pro Kern) aufgerufen.\n","        \"\"\"\n","        # 'rewards' ist ein Array (Numpy-Array der Länge NUM_CPU_CORES)\n","        # Wir hängen alle Rewards dieses Schritts an unseren Puffer an.\n","        self.step_rewards.extend(self.locals['rewards'])\n","        return True\n","\n","    def _on_rollout_end(self) -> None:\n","        \"\"\"\n","        Wird aufgerufen, nachdem der Rollout-Buffer voll ist.\n","        \"\"\"\n","        if not self.step_rewards:\n","            return # Nichts zu loggen\n","\n","        # Berechne den Durchschnitt aller gesammelten Belohnungen\n","        avg_step_reward = np.mean(self.step_rewards)\n","\n","        # Logge diesen Wert in den SB3-Logger.\n","        self.logger.record(\"reward/step_reward_avg\", avg_step_reward)\n","\n","        # Leere den Puffer für den nächsten Rollout\n","        self.step_rewards = []"],"metadata":{"trusted":true,"execution":{"iopub.status.busy":"2025-11-08T06:04:46.248341Z","iopub.execute_input":"2025-11-08T06:04:46.24852Z","iopub.status.idle":"2025-11-08T06:04:46.267692Z","shell.execute_reply.started":"2025-11-08T06:04:46.248483Z","shell.execute_reply":"2025-11-08T06:04:46.267174Z"},"id":"ZpofV3aVE1FG","executionInfo":{"status":"aborted","timestamp":1762583542592,"user_tz":-60,"elapsed":12,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}}},"outputs":[],"execution_count":null},{"cell_type":"code","source":["from google.colab import drive\n","drive.mount('/content/drive')"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"RINOHh-wYUDO","executionInfo":{"status":"ok","timestamp":1762620759060,"user_tz":-60,"elapsed":38390,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}},"outputId":"b1ca4387-61ce-4911-fe9e-bdfe418884d9"},"execution_count":1,"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /content/drive\n"]}]},{"cell_type":"code","source":["# ----------------------------------------------------------------------\n","# 4. Haupt-Trainingsschleife (Sweep) - JETZT MIT LSTM & PARALLELISIERUNG\n","# ----------------------------------------------------------------------\n","\n","# --- Helfer-Funktion für SubprocVecEnv ---\n","# Diese Funktion muss auf der obersten Ebene (außerhalb des Loops)\n","# definiert sein, damit sie von anderen Prozessen aufgerufen werden kann.\n","def create_env(env_kwargs: dict) -> gym.Env:\n","    \"\"\"Erstellt eine Instanz der Umgebung und wickelt sie in Monitor ein.\"\"\"\n","    env = PortfolioEnv(**env_kwargs)\n","    env = Monitor(env)\n","    return env\n","\n","# --- Datensatz-Pfade (global definieren) ---     \"DS4_Risk_Choice\", \"DS5_Regime_Switch\", \"DS6_Correlation_Trap\",\"DS7_Needle_in_Haystack\", \"DS8_Diversification_Win\", \"DS9_Factor_Timing\", \"DS10_SP100_Sim\", \"DS1_Winner_BH\", \"DS2_Perfect_Timing\",\n","BASE_DIR = \"/kaggle/input/toy-data/\"\n","scenario_keys = [\"DS4_Risk_Choice\"]\n","\n","dataset_paths = [os.path.join(BASE_DIR, f\"{key}.csv\") for key in scenario_keys]\n","\n","print(f\"--- Starte Sweep über {len(dataset_paths)} Szenarien ---\")\n","\n","# --- 3. Starte den \"Sweep\" über alle Datensätze ---\n","for path in dataset_paths:\n","\n","    # --- A. Initialisierung der Umgebung ---\n","    print(f\"\\n===== [NEUES SZENARIO]: {os.path.basename(path)} =====\")\n","\n","    CSV_FILE_PATH = path\n","\n","    try:\n","        all_cols = pd.read_csv(CSV_FILE_PATH, nrows=0).columns.tolist()\n","        RETURN_COLUMNS = [col for col in all_cols if col.lower() not in ['date', 'unnamed: 0']]\n","\n","        if not RETURN_COLUMNS:\n","            print(f\"WARNUNG: Keine Return-Spalten in {path} gefunden. Überspringe.\")\n","            continue\n","\n","        print(f\"Gefundene Return-Spalten: {RETURN_COLUMNS}\")\n","\n","    except Exception as e:\n","        print(f\"Konnte CSV nicht lesen oder Spalten nicht finden: {e}. Überspringe.\")\n","        continue\n","\n","    # <--- Nutze SubprocVecEnv für Parallelisierung ---\n","\n","    # 1. Definiere die Argumente für die Env-Instanzen\n","    env_kwargs = {\n","        'csv_path': CSV_FILE_PATH,\n","        'return_cols': RETURN_COLUMNS,\n","        'window_size': window_size,\n","        'initial_balance': initial_balance,\n","        'transaction_cost_pct': transaction_cost_pct\n","    }\n","\n","    # 2. Erstelle die Trainingsumgebung (parallel)\n","    print(f\"Nutze {NUM_CPU_CORES} CPU-Kerne parallel (SubprocVecEnv)...\")\n","    env = SubprocVecEnv([\n","        partial(create_env, env_kwargs=env_kwargs) for _ in range(NUM_CPU_CORES)\n","    ])\n","\n","    # 3. Erstelle die Evaluations-Umgebung (normal)\n","    eval_env = DummyVecEnv([partial(create_env, env_kwargs=env_kwargs)])\n","\n","    # --- B. Definiere die Konfiguration für W&B und SB3 ---\n","    config = {\n","        \"policy_type\": \"MultiInputPolicy\",\n","        \"total_timesteps\": total_timesteps_per_run,\n","        \"scenario\": os.path.basename(path),\n","        \"n_steps\": steps_per_rollout,\n","        \"batch_size\": mini_batch_size,\n","        \"n_epochs\": num_ppo_epochs,\n","        \"gamma\": gamma,\n","        \"gae_lambda\": lambda_gae,\n","        \"clip_range\": ppo_clip_epsilon,\n","        \"vf_coef\": vf_loss_coeff,\n","        \"ent_coef\": entropy_coeff,\n","        \"learning_rate\": learning_rate,\n","        \"window_size\": window_size,\n","        \"initial_balance\": initial_balance,\n","        \"transaction_cost_pct\": transaction_cost_pct,\n","        \"num_cpu_cores\": NUM_CPU_CORES\n","    }\n","\n","    policy_kwargs = dict(\n","        features_extractor_class=CustomCombinedExtractor,\n","        net_arch=dict(\n","            pi=[32],\n","            vf=[32]\n","        )\n","    )\n","\n","    # --- C. Starte W&B Run für dieses Szenario ---\n","    run = wandb.init(\n","        project=\"PPO_Portfolio_Sweep_SB3\",\n","        name=f\"{os.path.basename(path).replace('.csv', '')}_SB3_LSTM\",\n","        config=config,\n","        sync_tensorboard=True,\n","        monitor_gym=True,\n","        save_code=True,\n","        reinit=True\n","    )\n","\n","    # --- D. Initialisiere das SB3 PPO Modell ---\n","    model = PPO(\n","        policy=config[\"policy_type\"],\n","        env=env,\n","        n_steps=config[\"n_steps\"],\n","        batch_size=config[\"batch_size\"],\n","        n_epochs=config[\"n_epochs\"],\n","        gamma=config[\"gamma\"],\n","        gae_lambda=config[\"gae_lambda\"],\n","        clip_range=config[\"clip_range\"],\n","        vf_coef=config[\"vf_coef\"],\n","        ent_coef=config[\"ent_coef\"],\n","        learning_rate=config[\"learning_rate\"],\n","        policy_kwargs=policy_kwargs,\n","        tensorboard_log=f\"/kaggle/working/runs/{run.id}\",\n","        device=\"cuda\",\n","        verbose=0\n","    )\n","\n","    # --- E. Initialisiere die Callbacks ---\n","\n","    eval_freq_steps = steps_per_rollout/10\n","\n","    eval_callback = EvalCallback(\n","        eval_env,\n","        best_model_save_path=f\"/kaggle/working/models/{run.id}/best/\",\n","        log_path=f\"/kaggle/working/logs/{run.id}/eval/\",\n","        eval_freq=eval_freq_steps,\n","        n_eval_episodes=3,\n","        deterministic=True,\n","        render=False,\n","        verbose=0\n","    )\n","\n","    wandb_callback = WandbCallback(\n","        gradient_save_freq=0,\n","        model_save_path=None,\n","        verbose=0,\n","    )\n","\n","    # Callback 3: Der NEUE Step Logger\n","    step_reward_callback = AvgStepRewardLogger()\n","\n","    # Kombiniere ALLE Callbacks\n","    callback_list = CallbackList([wandb_callback, eval_callback, step_reward_callback])\n","\n","\n","    print(f\"Starte Training mit Stable Baselines 3 ({total_timesteps_per_run} steps)...\")\n","    print(f\"Policy: LSTM (CustomExtractor) auf {NUM_CPU_CORES} Kernen.\")\n","    print(\"Callbacks aktiv: eval/mean_reward UND reward/step_reward_avg\")\n","\n","    # --- F. Training ---\n","    model.learn(\n","        total_timesteps=config[\"total_timesteps\"],\n","        callback=callback_list,\n","        progress_bar=True\n","    )\n","\n","    # --- G. Aufräumen ---\n","    run.finish()\n","    env.close()\n","    eval_env.close()\n","    print(f\"--- Training für {path} abgeschlossen. ---\")\n","\n","print(\"\\n===== VOLLSTÄNDIGER SWEEP ABGESCHLOSSEN =====\")"],"metadata":{"trusted":true,"execution":{"iopub.status.busy":"2025-11-08T06:04:46.268465Z","iopub.execute_input":"2025-11-08T06:04:46.26868Z","iopub.status.idle":"2025-11-08T06:05:23.657803Z","shell.execute_reply.started":"2025-11-08T06:04:46.268664Z","shell.execute_reply":"2025-11-08T06:05:23.656865Z"},"id":"Gi7s3G4sE1FG","executionInfo":{"status":"aborted","timestamp":1762583542595,"user_tz":-60,"elapsed":13,"user":{"displayName":"Christoph Nachname","userId":"04640672557127032436"}}},"outputs":[],"execution_count":null}]}